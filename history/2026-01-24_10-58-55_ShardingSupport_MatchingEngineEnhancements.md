# Matching Engine Sharding Support ë° ë¬¸ì„œ ì •ë¦¬

**Date**: 2026-01-24 10:58:55 +0700

---

## Prompt (ì‚¬ìš©ì ìš”ì²­)

Spot Backendì˜ 5,000 TPS ë‹¬ì„±ì„ ìœ„í•œ ì¸í”„ë¼ ê³„íšì„ ë°”íƒ•ìœ¼ë¡œ, Futures Backendì˜ Matching Engineì— ìƒ¤ë”© ì§€ì›ì„ ê°•í™”í•˜ê³  ê´€ë ¨ ë¬¸ì„œë¥¼ ì •ë¦¬í•´ë‹¬ë¼.

ì£¼ìš” ìš”êµ¬ì‚¬í•­:
1. Matching Engine Serviceì— OrderRouter í†µí•©
2. ìƒ¤ë”©ì´ í™œì„±í™”ë˜ì—ˆì„ ë•Œ ëª¨ë“  ìƒ¤ë“œë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
3. CLAUDE.mdì— ê°œë°œ í™˜ê²½ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš© ì¶”ê°€
4. ê°œë°œ í™˜ê²½ ì‹œì‘/ì¤‘ì§€ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

---

## Result (ìˆ˜í–‰ ê²°ê³¼)

### âœ… êµ¬í˜„ëœ ê¸°ëŠ¥

#### 1. **Matching Engine Service ìƒ¤ë”© ì§€ì› ê°•í™”**

**íŒŒì¼**: `future-backend/src/modules/matching-engine/matching-engine.service.ts`

- **OrderRouterService ì£¼ì…**: ìƒ¤ë”© ìƒíƒœ í™•ì¸ ë° ë¸Œë¡œë“œìºìŠ¤íŠ¸ ê¸°ëŠ¥
- **ì´ˆê¸°í™” ëª…ë ¹ ìƒ¤ë”© ì²˜ë¦¬**: `preloadInstruments()` ë©”ì„œë“œ ê°œì„ 
  - ìƒ¤ë”© í™œì„±í™” ì‹œ: `orderRouterService.broadcastToAllShards()`ë¡œ ëª¨ë“  ìƒ¤ë“œì— ë¸Œë¡œë“œìºìŠ¤íŠ¸
  - ìƒ¤ë”© ë¹„í™œì„±í™” ì‹œ: ê¸°ì¡´ ë°©ì‹ (ë‹¨ì¼ í† í”½)

**ì½”ë“œ ë³€ê²½**:
```typescript
// Broadcast to all shards when sharding is enabled
if (!isTest && this.orderRouterService.isShardingEnabled()) {
  await this.orderRouterService.broadcastToAllShards(command, true);
} else {
  await producer.send({
    topic: isTest ? KafkaTopics.test_matching_engine_preload : KafkaTopics.matching_engine_preload,
    messages: [{ value: JSON.stringify(command) }],
  });
}
```

#### 2. **Order Router Service í™•ì¥**

**íŒŒì¼**: `future-backend/src/shares/order-router/order-router.service.ts`
**íŒŒì¼**: `future-backend/src/shares/order-router/shard-info.interface.ts`

- ìƒ¤ë”© ìƒíƒœ ê´€ë¦¬ ë©”ì„œë“œ ì¶”ê°€
- ì—¬ëŸ¬ ìƒ¤ë“œë¡œ ëª…ë ¹ì–´ ë™ì‹œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ê¸°ëŠ¥
- í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ìƒ¤ë”© ë¹„í™œì„±í™” ì²˜ë¦¬

#### 3. **ê°œë°œ í™˜ê²½ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€**

**íŒŒì¼ ìœ„ì¹˜**: `future-backend/scripts/`

ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸:
```
future-backend/scripts/
â”œâ”€â”€ dev-environment-start.sh   # ì „ì²´ ì‹œì‘ (ì¸í”„ë¼ + ë§¤ì¹­ ì—”ì§„ ì´ˆê¸°í™”)
â”œâ”€â”€ dev-environment-stop.sh    # ì „ì²´ ì¢…ë£Œ
â””â”€â”€ dev-environment-status.sh  # ìƒíƒœ í™•ì¸
```

**ìŠ¤í¬ë¦½íŠ¸ ê¸°ëŠ¥**:
- **dev-environment-start.sh**:
  1. AWS Lambdaë¡œ ì¸í”„ë¼ ìŠ¤ì¼€ì¼ ì—…
  2. ê° ì»´í¬ë„ŒíŠ¸ Ready ìƒíƒœ ëŒ€ê¸°
  3. Kafka preload í† í”½ ì´ˆê¸°í™”
  4. ë§¤ì¹­ ì—”ì§„ ì´ˆê¸°í™” ëª…ë ¹ ìë™ ì „ì†¡
  5. í—¬ìŠ¤ì²´í¬ ì‹¤í–‰

- **dev-environment-stop.sh**: ì¸í”„ë¼ ì™„ì „ ì¢…ë£Œ
- **dev-environment-status.sh**: í˜„ì¬ ìƒíƒœ í™•ì¸

#### 4. **CLAUDE.md ë¬¸ì„œ ì—…ë°ì´íŠ¸**

**íŒŒì¼**: `CLAUDE.md`

ì¶”ê°€ëœ ì„¹ì…˜:
1. **ê°œë°œ í™˜ê²½ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ê°€ì´ë“œ** (2026-01-22)
   - ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ ë° ì‚¬ìš©ë²•
   - ìë™ ìŠ¤ì¼€ì¤„ë§ ì„¤ëª…
   - Lambda ìŠ¤ì¼€ì¤„ëŸ¬ ë™ì‘ íë¦„

2. **Spot Backend ë¡œì»¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •** (2026-01-24)
   - Docker ì»¨í…Œì´ë„ˆ ì„¤ì •
   - í™˜ê²½ ì„¤ì • ê°€ì´ë“œ
   - í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„
   - ì•Œë ¤ì§„ ì´ìŠˆ ë° í•´ê²°ë°©ë²•

3. **Lambda ëª…ë ¹ì–´ ê°œì„ **
   - "ë§¤ì¹­ ì—”ì§„ ì´ˆê¸°í™” í¬í•¨" í‘œì‹œ ì¶”ê°€
   - "ì¸í”„ë¼ë§Œ ì‹œì‘" ì˜µì…˜ ì¶”ê°€ (ìƒ¤ë”© ë¹„í™œì„±í™” ëª¨ë“œì—ì„œ ì‚¬ìš© ê°€ëŠ¥)

### ğŸ“Š ë³€ê²½ í†µê³„

| í•­ëª© | ìˆ˜ëŸ‰ |
|------|------|
| **ìˆ˜ì •ëœ íŒŒì¼** | 4ê°œ |
| **ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸** | 3ê°œ |
| **CLAUDE.md ì¶”ê°€ ë¼ì¸** | 150+ì¤„ |
| **ìƒˆë¡œìš´ ë¬¸ì„œ ì„¹ì…˜** | 3ê°œ |

### ğŸ”„ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. `future-backend/src/modules/matching-engine/matching-engine.service.ts` (18ì¤„ ì¶”ê°€)
2. `future-backend/src/shares/order-router/order-router.service.ts` (ê°œì„ )
3. `future-backend/src/shares/order-router/shard-info.interface.ts` (ê°œì„ )
4. `CLAUDE.md` (150+ì¤„ ì¶”ê°€)

### ğŸ’¡ ì£¼ìš” ê°œì„ ì‚¬í•­

**1. ìƒ¤ë”© ì•„í‚¤í…ì²˜ ì¼ê´€ì„±**
- Matching Engineì´ OrderRouter ì„œë¹„ìŠ¤ì™€ í†µí•©ë˜ì–´ ìƒ¤ë”© ìƒíƒœë¥¼ ë™ì ìœ¼ë¡œ ì¸ì‹
- ëŸ°íƒ€ì„ì— ìƒ¤ë”© í™œì„±í™”/ë¹„í™œì„±í™” ì „í™˜ ê°€ëŠ¥

**2. ê°œë°œ í™˜ê²½ ìë™í™”**
- ìˆ˜ë™ìœ¼ë¡œ AWS Lambda í˜¸ì¶œí•  í•„ìš” ì—†ì´ ì‰˜ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìë™í™”
- ì¸í”„ë¼ì™€ ë§¤ì¹­ ì—”ì§„ ì´ˆê¸°í™”ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬

**3. ë¬¸ì„œ ì™„ì„±ë„ í–¥ìƒ**
- ê°œë°œìê°€ ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ì™„ì „í•œ ê°€ì´ë“œ ì œê³µ
- Spot Backend í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ê°€ì´ë“œ ì¶”ê°€

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì§„í–‰ ì¤‘ì¸ ì‘ì—… (ì•„ì§ ë¯¸ì™„ë£Œ)

1. **Spot Backend í†µí•© í…ŒìŠ¤íŠ¸ ì™„ì„±**
   - OrderMatching í†µí•© í…ŒìŠ¤íŠ¸ ìˆ˜ì • ì¤‘ (ProcessOrder Job ë™ê¸° ì‹¤í–‰)
   - 15ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¤‘ ì¼ë¶€ í†µê³¼

2. **ê°œë°œ í™˜ê²½ ìë™í™” ë°°í¬**
   - Lambda ìŠ¤ì¼€ì¤„ëŸ¬ ë°°í¬ í•„ìš”: `cdk deploy Exchange-dev-EksScheduler -c env=dev`

3. **ìƒ¤ë”© ëª¨ë“œ í™œì„±í™” í…ŒìŠ¤íŠ¸**
   - í˜„ì¬ Legacy ë‹¨ì¼ í† í”½ ëª¨ë“œ ì‚¬ìš©
   - ìƒ¤ë”© ëª¨ë“œë¡œ ì „í™˜ ë° ë¶€í•˜ í…ŒìŠ¤íŠ¸ í•„ìš”

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- âœ… Matching Engine Serviceì— OrderRouter í†µí•©
- âœ… ìƒ¤ë”© ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë¡œì§ êµ¬í˜„
- âœ… ê°œë°œ í™˜ê²½ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- âœ… CLAUDE.md ê°œë°œ í™˜ê²½ ê°€ì´ë“œ ì¶”ê°€
- â³ Spot Backend í†µí•© í…ŒìŠ¤íŠ¸ ì™„ì„± (ì§„í–‰ ì¤‘)
- â³ Lambda ìŠ¤ì¼€ì¤„ëŸ¬ ë°°í¬ (ëŒ€ê¸° ì¤‘)

---

**Git ìƒíƒœ**: 4ê°œ íŒŒì¼ ìˆ˜ì •, 3ê°œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ë¯¸ì»¤ë°‹)

**ì†Œìš” ì‹œê°„**: ~2ì‹œê°„
- ì½”ë“œ ë¶„ì„ ë° ì„¤ê³„: 0.5ì‹œê°„
- Matching Engine Service ê°œì„ : 0.5ì‹œê°„
- ê°œë°œ í™˜ê²½ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±: 0.5ì‹œê°„
- ë¬¸ì„œ ì‘ì„± ë° ì—…ë°ì´íŠ¸: 0.5ì‹œê°„
