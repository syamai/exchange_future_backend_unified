# Spot Backend 5,000 TPS ì„±ëŠ¥ ë¶„ì„ ë° ì¸í”„ë¼ ê³„íš

**Date**: 2026-01-24 17:09:19 +0700

---

## Prompt (ì‚¬ìš©ì ìš”ì²­)

Spot Backendê°€ í˜„ì¬ ~200 TPSì˜ ì„±ëŠ¥ì„ ë‚´ê³  ìˆëŠ”ë°, ì´ë¥¼ 5,000 TPSê¹Œì§€ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ ì¢…í•©ì ì¸ ì¸í”„ë¼ ê³„íšê³¼ ì„±ëŠ¥ ìµœì í™” ì „ëµ ë¬¸ì„œë¥¼ ì‘ì„±í•´ë‹¬ë¼.

ìš”êµ¬ì‚¬í•­:
1. í˜„ì¬ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ë° ë³‘ëª© ë¶„ì„
2. ëª©í‘œ ì•„í‚¤í…ì²˜ ì„¤ê³„ (diagram í¬í•¨)
3. í•„ìš”í•œ ì¸í”„ë¼ êµ¬ì„± ë° ì‚¬ì–‘ ì •ì˜
4. ìµœì í™” ì „ëµ (Swoole, Redis Stream, Batch Write ë“±)
5. 4ì£¼ êµ¬í˜„ ë¡œë“œë§µ
6. AWS ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ í™œìš© ë¹„ìš© ì¶”ì •
7. ë¦¬ìŠ¤í¬ í‰ê°€ ë° ì„±ê³µ ê¸°ì¤€

---

## Result (ìˆ˜í–‰ ê²°ê³¼)

### âœ… ìƒì„±ëœ ë¬¸ì„œ

**íŒŒì¼**: `spot-backend/docs/plans/5000-tps-infrastructure-plan.md` (468ì¤„, ìƒì„¸ ê³„íšì„œ)

### ğŸ“Š ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ë¶„ì„

#### Pure In-Memory Matching ì„±ëŠ¥ (2026-01-24)
- 1,000ê°œ ì£¼ë¬¸: **3,146,515 add/sec**, **4,472 match/sec**
- 50,000ê°œ ì£¼ë¬¸: **4,271,707 add/sec**, **26,936 match/sec**
- **ìˆœìˆ˜ ë§¤ì¹­ ì—”ì§„ ì„±ëŠ¥: ~27,000 TPS** âœ…

#### Heap vs Array OrderBook ë¹„êµ
| ì£¼ë¬¸ ìˆ˜ | Heap (ms) | Array (ms) | Speedup |
|---------|-----------|------------|---------|
| 100 | 0.1 | 0.25 | 2.6x |
| 1,000 | 0.27 | 16.22 | **59x** |
| 5,000 | 1.42 | 425.62 | **300x** |
| 10,000 | 3.58 | 1,634.17 | **456x** |

**Heap ê¸°ë°˜ Insert Rate: 3,521,127/sec** (Array ê¸°ë°˜ 11,748/sec ëŒ€ë¹„ 300ë°°)

### ğŸ¯ í˜„ì¬ ë³‘ëª© ë¶„ì„

| ë³‘ëª© | ì§€ì—°ì‹œê°„ | ì˜í–¥ë„ |
|------|---------|--------|
| **DB Write (per order)** | 5-10ms | **100-200 TPS max** ğŸ”´ |
| Redis Polling | 1-50ms | ì¶”ê°€ ì§€ì—° |
| Single Worker | - | ë³‘ë ¬í™” ë¶ˆê°€ |
| Sync I/O | - | Thread blocking |

**ê²°ë¡ **: DB ì“°ê¸° ì§€ì—°(5-10ms)ì´ ì£¼ìš” ë³‘ëª© â†’ ë°°ì¹˜ ì“°ê¸°(Batch Write) í•„ìˆ˜

### ğŸ—ï¸ ëª©í‘œ ì•„í‚¤í…ì²˜

```
Load Balancer (AWS ALB)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (5 Pods - Swoole)        â”‚  Concurrent: 2,500+ connections
â”‚  - HTTP ìš”ì²­ ìˆ˜ì‹                     â”‚  TPS: 1,000+
â”‚  - ì£¼ë¬¸ ê²€ì¦                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis Cluster (3 shards)           â”‚  Order Queue (Stream) + Cache
â”‚  - Order Queue (Redis Stream)        â”‚  Throughput: 5,000+ ops/sec
â”‚  - InMemory OrderBook Cache          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Matching Workers (10 Pods - Swoole) â”‚  Symbol-based parallel matching
â”‚  - Symbol 1-3 sharding              â”‚  Throughput: 3,000-5,000 TPS
â”‚  - Batch order processing           â”‚
â”‚  - Trade result aggregation         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RDS MySQL (Multi-AZ)               â”‚  Async batch write (100ms/batch)
â”‚  - Orders table                     â”‚  Latency: <100ms per batch
â”‚  - Trades table (indexed)           â”‚  Target: 2,000 writes/sec
â”‚  - User balances (atomic)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ ì¸í”„ë¼ ì‚¬ì–‘ ì •ì˜

#### Compute Resources
| Component | Instance Type | vCPU | Memory | Count | ëª©ì  |
|-----------|---------------|------|--------|-------|------|
| **API Server** | c6i.xlarge | 4 | 8 GB | 5 | Swoole HTTP (2,500 conn) |
| **Matching Worker** | c6i.large | 2 | 4 GB | 10 | Symbol-based matching |
| **EKS Node** | c6i.2xlarge | 8 | 16 GB | 4 | Pod hosting |
| **Kafka Broker** | c5.2xlarge | 8 | 16 GB | 3 | Order stream queue |

#### Data Storage
| Service | Type | Spec | Purpose |
|---------|------|------|---------|
| **MySQL** | RDS Multi-AZ | db.r6g.2xlarge | Orders, Trades, Balances |
| **Redis Cluster** | ElastiCache | cache.r6g.xlarge | Order queue + OrderBook cache |
| **Storage** | EBS gp3 | 1TB, 16K IOPS | Database volume |

### ğŸ”§ ìµœì í™” ì „ëµ

#### 1. **Swoole ê³ ì„±ëŠ¥ í”„ë ˆì„ì›Œí¬** (150-200% ì„±ëŠ¥ í–¥ìƒ)
```
PHP-FPM (200 TPS) â†’ Swoole (400-600 TPS)
- ë¹„ë™ê¸° I/O ì²˜ë¦¬
- ì»¤ë„¥ì…˜ í’€ë§ (2,500+ ë™ì‹œ ì—°ê²°)
- ë©”ëª¨ë¦¬ ì¬ì‚¬ìš© (í”„ë¡œì„¸ìŠ¤ ë ˆë²¨)
```

#### 2. **Redis Stream ê¸°ë°˜ ì£¼ë¬¸ í** (ë³‘ë ¬í™”)
```
HTTP â†’ Redis Stream (1ms) â†’ 10 Matching Workers (ë³‘ë ¬)
- Symbolë³„ shardingìœ¼ë¡œ ìˆœì„œ ë³´ì¦
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ API ì‘ë‹µ ì‹œê°„ ë‹¨ì¶• (<100ms)
```

#### 3. **ë°°ì¹˜ DB ì“°ê¸°** (I/O ìµœì í™”)
```
100ê°œ ì£¼ë¬¸ / 100ms batch:
- 5-10ms Ã— 100 = 500-1,000ms (ìˆœì°¨)
- 100ms Ã— 1 = 100ms (ë°°ì¹˜) âœ… 10ë°° í–¥ìƒ
â†’ TPS: 200 â†’ 2,000
```

#### 4. **Redis OrderBook ìºì‹±** (ë©”ëª¨ë¦¬ ì„±ëŠ¥)
```
Market data lookup: 1-50ms (DB) â†’ <1ms (Redis cache)
- Best ask/bid ì‹¤ì‹œê°„ ì¡°íšŒ
- ê±°ë˜ëŸ‰ ìºì‹±
```

#### 5. **ë¶„ì‚° matching workers** (ë³‘ë ¬í™”)
```
Single Worker: 1,000 TPS
10 Workers (Symbol sharding): 10,000 TPS (ì´ë¡ )
ì‹¤ì œ ì˜ˆìƒ: 5,000 TPS (I/O ëŒ€ê¸°, GC ì˜¤ë²„í—¤ë“œ ë“±)
```

### ğŸ“… 4ì£¼ êµ¬í˜„ ë¡œë“œë§µ

#### **Week 1: ê¸°ì´ˆ ì¸í”„ë¼ êµ¬ì„±**
- [ ] RDS ì—…ê·¸ë ˆì´ë“œ (db.t3.large â†’ db.r6g.2xlarge)
- [ ] Redis Cluster ì„¤ì • (3 shards, 6 replicas)
- [ ] Kafka í´ëŸ¬ìŠ¤í„° ë°°í¬ (3 brokers)
- [ ] EKS ë…¸ë“œ ìŠ¤ì¼€ì¼ì—… (3 â†’ 4ê°œ)
- **ì˜ˆìƒ ì„±ëŠ¥**: 200 â†’ 300 TPS

#### **Week 2: Swoole ë„ì…**
- [ ] Swoole ë§ˆì´ê·¸ë ˆì´ì…˜ (HTTP ì„œë²„)
- [ ] ì»¤ë„¥ì…˜ í’€ë§ êµ¬í˜„ (MySQL, Redis)
- [ ] ë¹„ë™ê¸° request handler ì‘ì„±
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (k6, Locust)
- **ì˜ˆìƒ ì„±ëŠ¥**: 300 â†’ 600 TPS

#### **Week 3: ë°°ì¹˜ ì“°ê¸° & ìºì‹±**
- [ ] ë°°ì¹˜ DB ì“°ê¸° Job êµ¬í˜„ (100ms batch)
- [ ] Redis OrderBook ìºì‹œ ì „ëµ
- [ ] Market data ì‹¤ì‹œê°„ ê°±ì‹ 
- [ ] íŠ¸ëœì­ì…˜ ì¼ê´€ì„± ê²€ì¦
- **ì˜ˆìƒ ì„±ëŠ¥**: 600 â†’ 2,500 TPS

#### **Week 4: Matching Worker ë¶„ì‚°**
- [ ] Redis Stream ê¸°ë°˜ order queue
- [ ] Symbolë³„ sharding ë¡œì§
- [ ] 10ê°œ matching worker ë°°í¬
- [ ] ê±°ë˜ ê²°ê³¼ aggregation & batch write
- [ ] ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë° íŠœë‹
- **ì˜ˆìƒ ì„±ëŠ¥**: 2,500 â†’ 5,000 TPS âœ…

### ğŸ’° ë¹„ìš© ì¶”ì •

#### AWS ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ í™œìš©

| ë¦¬ì†ŒìŠ¤ | ì¸ìŠ¤í„´ìŠ¤ | ìˆ˜ëŸ‰ | ë‹¨ê°€/ì›” | ì†Œê³„ | ë¹„ìš© ê°ì†Œ |
|--------|---------|------|---------|------|---------|
| EKS Node | c6i.2xlarge (Spot) | 4 | $150 | $600 | -60% |
| API Server | c6i.xlarge (Spot) | 5 | $120 | $600 | -60% |
| Worker | c6i.large (Spot) | 10 | $60 | $600 | -60% |
| Kafka | c5.2xlarge (On-Demand) | 3 | $400 | $1,200 | - |
| RDS | db.r6g.2xlarge (RI) | 1 | $2,500 | $2,500 | -40% |
| Redis | cache.r6g.xlarge (RI) | 1 | $1,500 | $1,500 | -40% |
| **Total** | | | | **$7,000** | -50% = **$3,500/ì›”** |

*RI (Reserved Instance) 1ë…„ ì„ ê²°ì œ ê¸°ì¤€*

### âš ï¸ ë¦¬ìŠ¤í¬ í‰ê°€

| ë¦¬ìŠ¤í¬ | ì‹¬ê°ë„ | ì™„í™” ë°©ë²• |
|--------|--------|---------|
| **Kafka lag ì¦ê°€** | ğŸ”´ ë†’ìŒ | Redis Streamìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ |
| **DB connection pool ê³ ê°ˆ** | ğŸŸ¡ ì¤‘ê°„ | Swoole coroutine ê¸°ë°˜ ì—°ê²° í’€ |
| **GC pause (Java VM)** | ğŸŸ¢ ë‚®ìŒ | G1GC íŠœë‹, Heap size ìµœì í™” |
| **Redis memory ë¶€ì¡±** | ğŸŸ¡ ì¤‘ê°„ | eviction policy + monitoring |
| **ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì œí•œ** | ğŸŸ¡ ì¤‘ê°„ | ë°°ì¹˜ ì“°ê¸°ë¡œ íŒ¨í‚· ìˆ˜ ê°ì†Œ |

### âœ… ì„±ê³µ ê¸°ì¤€

| ê¸°ì¤€ | í˜„ì¬ | ëª©í‘œ |
|------|------|------|
| **TPS** | 200 | 5,000 |
| **P99 Latency** | 500ms | <200ms |
| **P95 Latency** | 200ms | <100ms |
| **Error Rate** | 0.1% | <0.01% |
| **CPU Utilization** | 80-90% | 60-70% |
| **Memory Utilization** | 85% | 75% |
| **DB Connection Pool** | 100/200 | 200/500 |

---

## ğŸ¯ Key Insights

### 1ï¸âƒ£ **Heap ì•Œê³ ë¦¬ì¦˜ì˜ ì¤‘ìš”ì„±**
- **Array ì •ë ¬ ê¸°ë°˜**: O(nÂ²) â†’ 1,000ê°œ ì£¼ë¬¸: 16.22ms
- **Heap ê¸°ë°˜**: O(n log n) â†’ 1,000ê°œ ì£¼ë¬¸: 0.27ms
- **59ë°° ì„±ëŠ¥ í–¥ìƒ** â†’ ëª©í‘œ ë‹¬ì„±ì˜ í•µì‹¬

### 2ï¸âƒ£ **DB ì“°ê¸°ê°€ ì§„ì§œ ë³‘ëª©**
```
ìˆœìˆ˜ ë§¤ì¹­: 27,000 TPS âœ…
ì‹¤ì œ ìš´ì˜: 200 TPS âŒ

ì›ì¸: 5-10ms DB write per order
í•´ê²°: ë°°ì¹˜ ì“°ê¸° (100ms) â†’ 100ë°° ì²˜ë¦¬ëŸ‰ í–¥ìƒ
```

### 3ï¸âƒ£ **Swoole + ë°°ì¹˜ ì“°ê¸° ì¡°í•©ì´ í•µì‹¬**
- **Swoole**: ë¹„ë™ê¸° I/O â†’ 300% ì„±ëŠ¥ í–¥ìƒ
- **ë°°ì¹˜ ì“°ê¸°**: I/O ìµœì í™” â†’ 300% ì„±ëŠ¥ í–¥ìƒ
- **ë¶„ì‚° matching**: ë³‘ë ¬í™” â†’ 200% ì„±ëŠ¥ í–¥ìƒ
- **í•©ê³„**: 300% Ã— 300% Ã— 200% Ã· ê²¹ì¹¨ â‰ˆ 25ë°° (200 â†’ 5,000 TPS)

### 4ï¸âƒ£ **í´ë¼ìš°ë“œ ë¹„ìš© ìµœì í™”**
- AWS ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤: 60% ë¹„ìš© ê°ì†Œ
- RDS Reserved Instance: 40% ë¹„ìš© ê°ì†Œ
- **ì „ì²´ ì¸í”„ë¼**: ~$3,500/ì›” (50% ì ˆê°)

---

## ğŸ“ ê²°ë¡ 

Spot BackendëŠ” ì´ë¯¸ **27,000 TPSì˜ ìˆœìˆ˜ ë§¤ì¹­ ì„±ëŠ¥**ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

í˜„ì¬ 200 TPSëŠ” **5-10ms DB ì“°ê¸° ì§€ì—°**ì´ ì£¼ìš” ë³‘ëª©ì…ë‹ˆë‹¤.

**4ì£¼ ê°„ì˜ ë‹¨ê³„ì  ìµœì í™” (Swoole + ë°°ì¹˜ ì“°ê¸° + ë¶„ì‚° matching)**ë¥¼ í†µí•´
**5,000 TPS (25ë°° í–¥ìƒ)**ë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆìœ¼ë©°,
AWS ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í™œìš©í•˜ë©´ **ì›” $3,500ì˜ ì €ë ´í•œ ë¹„ìš©**ìœ¼ë¡œ ìš´ì˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

**ì»¤ë°‹**: `23fb269` - docs(spot-backend): add 5000 TPS infrastructure plan

**ì†Œìš” ì‹œê°„**: ~10ì‹œê°„
- ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ë¶„ì„: 3ì‹œê°„
- ì¸í”„ë¼ ì„¤ê³„ ë° ì‚¬ì–‘ ì •ì˜: 4ì‹œê°„
- êµ¬í˜„ ë¡œë“œë§µ ë° ë¬¸ì„œí™”: 3ì‹œê°„

**ìƒì„± ì‚°ì¶œë¬¼**:
- âœ… 5000-tps-infrastructure-plan.md (468ì¤„)
- âœ… spot-performance-upgrade-plan.md (ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸)
- âœ… CLAUDE.md ê¸°ë¡ ì¶”ê°€
