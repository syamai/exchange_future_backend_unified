apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: spot-backend-dev

resources:
  - ../../base

nameSuffix: -dev

# Reduce replicas for dev environment
replicas:
  - name: spot-backend-api
    count: 1
  - name: spot-backend-worker
    count: 2
  - name: spot-matching-engine
    count: 1

# Override images with ECR registry (critonex account)
images:
  - name: exchange/spot-backend
    newName: 990781424619.dkr.ecr.ap-northeast-2.amazonaws.com/exchange/spot-backend
    newTag: main

# Patch resources for dev (smaller)
patches:
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: spot-backend-api
      spec:
        template:
          spec:
            containers:
              - name: spot-backend
                resources:
                  requests:
                    cpu: "100m"
                    memory: "256Mi"
                  limits:
                    cpu: "500m"
                    memory: "512Mi"
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: spot-backend-worker
      spec:
        template:
          spec:
            containers:
              - name: spot-worker
                resources:
                  requests:
                    cpu: "100m"
                    memory: "128Mi"
                  limits:
                    cpu: "500m"
                    memory: "512Mi"

# ConfigMap patches
patchesStrategicMerge:
  - |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: spot-backend-config
    data:
      APP_ENV: "development"
      APP_DEBUG: "true"
      LOG_LEVEL: "debug"
  - |-
    apiVersion: v1
    kind: Secret
    metadata:
      name: spot-backend-secrets
    type: Opaque
    stringData:
      APP_KEY: "base64:DevSecretKeyForCICD2026ExchangeApp"
      DB_HOST: "exchange-cicd-dev-mysql.cv882g4ue5py.ap-northeast-2.rds.amazonaws.com"
      DB_USERNAME: "admin"
      DB_PASSWORD: "ExchangeDevPass2026"
      # Read replica uses same host in dev (no separate replica)
      SLAVE_DB_HOST: "exchange-cicd-dev-mysql.cv882g4ue5py.ap-northeast-2.rds.amazonaws.com"
      SLAVE_DB_USERNAME: "admin"
      SLAVE_DB_PASSWORD: "ExchangeDevPass2026"
      REDIS_HOST: "exchange-cicd-dev-redis.pyibmf.0001.apn2.cache.amazonaws.com"
      REDIS_PASSWORD: ""
